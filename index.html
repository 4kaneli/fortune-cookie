<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fortune Cookie</title>
<style>
body {
    margin:0;
    overflow:hidden;
    background:#000;
    font-family: Arial, sans-serif;
}
canvas {
    border:0;
    display:block;
    position:absolute;
    top:0;
    left:0;
    z-index:1;
}
#anotherBtn {
    position:absolute;
    left:50%;
    transform:translate(-50%,0);
    padding:10px 20px;
    font-size:18px;
    cursor:pointer;
    display:none; /* rimane nascosto inizialmente */
    z-index:3;
    border-radius: 20px;
    border:none;
    background:#f7f436;
    opacity:0;           /* inizialmente trasparente */
    transition: opacity 1s ease; /* fade-in */
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<button id="anotherBtn">More?ðŸ¥ </button>

<audio id="crackSound" src="crack2.wav"></audio>
<audio id="breakSound" src="fairy.wav"></audio>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const anotherBtn = document.getElementById('anotherBtn');
const crackSound = document.getElementById('crackSound');
const breakSound = document.getElementById('breakSound');

const cookieWhole = new Image();
cookieWhole.src = 'cookie_whole.png';
const cookieBroken = new Image();
cookieBroken.src = 'cookie_broken.png';
const bgImg = new Image();
bgImg.src = 'restaurant.jpg';

/* ---------------- CONFIG ---------------- */
let config = {
    desktop: {
        cookieScale: 750,
        subMessageFont: 28,
        mainMessageFont: 50,
        mainMessageYOffset: -0,
        finalMessageFont: 40,
        finalMessageYOffset: -500,
        anotherBtnTop: 80,
        anotherBtnFontSize: 28,
        anotherBtnPaddingX: 20,
        anotherBtnPaddingY: 10,
        transitionSpeed: 0.03,
        clicksToBreak: 9
    },
    mobile: {
        cookieScale: 1200,
        subMessageFont: 44,
        mainMessageFont: 52,
        mainMessageYOffset: -350,
        finalMessageFont: 46,
        finalMessageYOffset: -800,
        anotherBtnTop: 70,
        anotherBtnFontSize: 46,
        anotherBtnPaddingX: 40,
        anotherBtnPaddingY: -200,
        transitionSpeed: 0.06,
        clicksToBreak: 9
    },
    current: {}
};

/* ---------------- VAR ---------------- */
let clickCount = 0;
let state = "idle";
let shakeOffset = 15;
let shakeFrames = 5;
let shakeProgress = 0;
let shakeDirection = 1;
let subMessageToggle = false;
let subFontSize = 0;
let maxSubFontSize = 50;
let fontIncrement = 2;

let cookieX = -800;
let cookieTargetX = 0;
let cookieReady = false;
let cookieOldX = null;
let animatingSwap = false;

let fortuneMessage = "";
let displayedText = "";
let charIndex = 0;
let typingSpeed = 50;
let lastCharTime = 0;

let sparks = [];
let subPulse = 0;
let btnStart = 0;

const fortunes = [
    "Oopsâ€¦ that cookie knew too much!",
    "Congratulations! This cookie is empty.",
    "Great things are comingâ€¦ not for you.",
    "Someone will steal your food today.",
    "Your luck is like Wi-Fiâ€¦ mostly offline.",
    "Smile! Or not, your choice.",
    "You will find a mysterious sockâ€¦ alone.",
    "Beware of ambitious cats.",
    "Your coffee might fall in the next few days...",
    "I know somethingâ€¦ but I wonâ€™t tell you."
];

/* ---------------- FUNZIONI ---------------- */
function drawBackground() {
    if(!bgImg.width) return;

    const imgRatio = bgImg.width / bgImg.height;
    const canvasRatio = canvas.width / canvas.height;
    let drawWidth, drawHeight;

    if(canvasRatio > imgRatio){
        drawWidth = canvas.width;
        drawHeight = drawWidth / imgRatio;
    } else {
        drawHeight = canvas.height;
        drawWidth = drawHeight * imgRatio;
    }
    const drawX = (canvas.width - drawWidth)/2;
    const drawY = (canvas.height - drawHeight)/2;

    if(window.innerWidth < 1000){ // sfondo sfocato solo mobile
        ctx.filter = "blur(5px)";
    } else {
        ctx.filter = "blur(5px)";
    }
    ctx.drawImage(bgImg, drawX, drawY, drawWidth, drawHeight);
    ctx.filter = "none";
}

function drawSparks() {
    for(let i = sparks.length-1; i>=0; i--){
        let s = sparks[i];
        ctx.fillStyle = s.color;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
        ctx.fill();
        s.x += s.vx;
        s.y += s.vy;
        s.life--;
        if(s.life <= 0) sparks.splice(i,1);
    }
}

function drawCookie(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    drawSparks();

    const centerY = canvas.height/2;
    const targetWidth = config.current.cookieScale;
    let scale = targetWidth / cookieWhole.width;
    let imgW = cookieWhole.width * scale;
    let imgH = cookieWhole.height * scale;

    // entrata biscotto
    if(!cookieReady){
        cookieX += (cookieTargetX - cookieX) * config.current.transitionSpeed;
        if(Math.abs(cookieX - cookieTargetX) < 1){
            cookieX = cookieTargetX;
            cookieReady = true;
        }
    }

    let xOffset = 0;
    if(shakeProgress > 0){
        xOffset = shakeOffset * shakeDirection;
        shakeDirection *= -1;
        shakeProgress--;
    }

    if(animatingSwap && cookieOldX !== null){
        ctx.drawImage(cookieBroken, cookieOldX, centerY - imgH/2, imgW, imgH);
        cookieOldX += 20;
    }

    if(state === "idle"){
        ctx.drawImage(cookieWhole, cookieX + xOffset, centerY - imgH/2, imgW, imgH);

        // Titolo
        ctx.fillStyle = "#FFFFFF";
        ctx.textAlign = "center";
        ctx.font = `bold ${config.current.mainMessageFont}px Arial`;
        ctx.fillText("CLICK THE COOKIE TO BREAK IT!", canvas.width/2, centerY - imgH/2 + config.current.mainMessageYOffset);

    
// Messaggio alternato dal 4Â° click
if(clickCount >= 4){
    const msg = subMessageToggle ? "again!" : "click harder!";

    // Calcolo dimensioni rettangolo
    ctx.font = `bold ${subFontSize}px Arial`;
    const textMetrics = ctx.measureText(msg);
    const paddingX = 15;
    const paddingY = 10;

    // Pulsazione
    let scale = 1 + 0.05 * Math.sin(Date.now()/200);

    ctx.save();
    ctx.translate(canvas.width/2, centerY - imgH/2 + 50);

    // Rettangolo nero dietro testo
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    const rectW = textMetrics.width + paddingX * 2;
    const rectH = subFontSize + paddingY * 2;
    ctx.fillRect(-rectW/2, -rectH/2, rectW, rectH);

    // Testo sopra
    ctx.scale(scale, scale);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "red";
    ctx.fillText(msg, 0, 0);

    ctx.restore();
}


    } else if(state === "broken" && !animatingSwap){
        ctx.drawImage(cookieBroken, canvas.width/2 - imgW/2, centerY - imgH/2, imgW, imgH);

        const textMetrics = ctx.measureText(displayedText);
        const padding = 20;
        const rectX = canvas.width/2 - textMetrics.width/2 - padding;
        const rectY = centerY + imgH/2 + config.current.finalMessageYOffset - config.current.finalMessageFont;
        const rectW = textMetrics.width + padding*2;
        const rectH = config.current.finalMessageFont + padding;
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(rectX, rectY, rectW, rectH);

        if(Date.now() - lastCharTime > typingSpeed && charIndex < fortuneMessage.length){
            displayedText += fortuneMessage[charIndex];
            charIndex++;
            lastCharTime = Date.now();
        }

        ctx.font = `bold ${config.current.finalMessageFont}px Arial`;
        ctx.fillStyle = "yellow";
        ctx.textAlign = "center";
        ctx.fillText(displayedText, canvas.width/2, centerY + imgH/2 + config.current.finalMessageYOffset);
    }
}

/* ----------------- CLICK ----------------- */
canvas.addEventListener('click', (e)=>{
    if(!cookieReady || state !== "idle" || animatingSwap) return;
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    const targetWidth = config.current.cookieScale;
    let scale = targetWidth / cookieWhole.width;
    let imgW = cookieWhole.width * scale;
    let imgH = cookieWhole.height * scale;

    const cookieRect = { left: cookieX, right: cookieX+imgW, top: canvas.height/2-imgH/2, bottom: canvas.height/2+imgH/2 };

    if(mouseX>=cookieRect.left && mouseX<=cookieRect.right && mouseY>=cookieRect.top && mouseY<=cookieRect.bottom){
        clickCount++;

        // particelle ad ogni click
        for(let i=0;i<20;i++){
            sparks.push({
                x: mouseX,
                y: mouseY,
                vx:(Math.random()-0.5)*6,
                vy:(Math.random()-0.5)*6,
                size: Math.random()*4+2,
                color:["yellow","orange","white"][Math.floor(Math.random()*3)],
                life:30+Math.random()*20
            });
        }

        if(clickCount < config.current.clicksToBreak){
            crackSound.currentTime = 0;
            crackSound.play();
            shakeProgress = shakeFrames;

            if(clickCount>=4){
                subMessageToggle = !subMessageToggle;
                if(subFontSize < maxSubFontSize) subFontSize += fontIncrement;
                subPulse = Date.now();
            }
        } else {
           if(clickCount >= config.current.clicksToBreak){
    state = "broken";
    breakSound.play();
    const randomIndex = Math.floor(Math.random()*fortunes.length);
    fortuneMessage = fortunes[randomIndex];
    displayedText = "";
    charIndex = 0;
    lastCharTime = 0;

    const isMobile = window.innerWidth 
    const sizeFactor = isMobile ? 3 : 0.5;   // doppia dimensione su mobile
    const speedFactor = isMobile ? 4 : 0.3; // scintille piÃ¹ veloci su mobile

    for(let i=0;i<90;i++){
        sparks.push({
            x: canvas.width/2,
            y: canvas.height/2,
            vx: (Math.random()-0.5)*6*speedFactor,
            vy: (Math.random()-0.5)*6*speedFactor,
            size: (Math.random()*4+2)*sizeFactor,
            color: "yellow",
            life: 40 + Math.random()*20
        });
    }

  setTimeout(()=>{
    anotherBtn.style.top = config.current.anotherBtnTop + "%";
    anotherBtn.style.display='block';
    // Forza il fade-in
    setTimeout(()=>{ 
        anotherBtn.style.opacity = 1; 
    }, 50); // leggero delay per triggerare la transizione
}, 2000);
}


            // inizia animazione bottone
            btnStart = Date.now();
            animateButton();
        }
    }
});

/* ----------------- MORE BUTTON ----------------- */
anotherBtn.addEventListener('click', ()=>{
    anotherBtn.style.display='none';
    clickCount=0;
    subMessageToggle=false;
    subFontSize=config.current.subMessageFont;
    animatingSwap=true;
    cookieOldX=canvas.width/2 - config.current.cookieScale/2;
    displayedText="";
    charIndex=0;
    cookieX=-800;
    cookieReady=false;
    state="idle";

    const animInterval = setInterval(()=>{
        cookieX += (cookieTargetX-cookieX)*config.current.transitionSpeed;
        cookieOldX += 20;
        if(Math.abs(cookieX-cookieTargetX)<1){
            cookieX=cookieTargetX;
            cookieReady=true;
            animatingSwap=false;
            cookieOldX=null;
            fortuneMessage="";
            clearInterval(animInterval);
        }
    },16);
});

function animateButton(){
    anotherBtn.style.display="block";
    function dondolo(){
        let t = (Date.now()-btnStart)/200;
        anotherBtn.style.transform = `translate(-50%,0) rotate(${Math.sin(t)*5}deg)`;
        if(anotherBtn.style.display=="block") requestAnimationFrame(dondolo);
    }
    dondolo();
}

/* ----------------- LOOP ----------------- */
function loop(){
    drawCookie();
    requestAnimationFrame(loop);
}

/* ----------------- MOBILE ADJUST ----------------- */
function adjustForMobile(){
    if(window.innerWidth<1000){
        config.current={...config.mobile};
    } else {
        config.current={...config.desktop};
    }
    cookieTargetX=canvas.width/2 - config.current.cookieScale/2;
    subFontSize=config.current.subMessageFont;
    anotherBtn.style.fontSize=config.current.anotherBtnFontSize+"px";
    anotherBtn.style.padding=config.current.anotherBtnPaddingY+"px "+config.current.anotherBtnPaddingX+"px";
    anotherBtn.style.top=config.current.anotherBtnTop+"%";
}

window.addEventListener('resize', adjustForMobile);
adjustForMobile();
loop();
</script>
</body>
</html>
